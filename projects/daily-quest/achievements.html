<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport            getStats(){
                const u=JSON.parse(localStorage.getItem('userData')||'{}');
                const c=JSON.parse(localStorage.getItem('bq-custom')||'[]');
                const h=JSON.parse(localStorage.getItem('completionHistory')||'[]');
                return{
                    level:u.level||1,totalXP:u.totalXP||0,currentStreak:u.streak||0,questsCompleted:h.length,customQuests:c.length,
                    perfectDays:this.countPerfect(),earlyCompletions:this.countEarly(),lateCompletions:this.countLate(),
                    weekendQuests:this.countWeekend(),comebacks:parseInt(localStorage.getItem('comebacks')||'0')
                };
            }"width=device-width, initial-scale=1.0">
    <title>Erfolge - Daily Quest System</title>
    <style>
        :root{--p:#66BB6A;--s:#FFD54F;--bg:#121212;--card:#1e1e1e;--txt:#fff;--border:#333}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:system-ui;background:var(--bg);color:var(--txt);line-height:1.6;padding:1rem;max-width:1200px;margin:0 auto}
        .n{text-align:center;margin-bottom:2rem;padding-bottom:1rem;border-bottom:1px solid var(--border)}
        .n a{color:var(--txt);text-decoration:none;margin:0 .5rem;font-size:.9rem;opacity:.8;transition:all .3s}
        .n a:hover{color:var(--p);opacity:1}
        .h{text-align:center;margin-bottom:2rem;background:var(--card);padding:1.5rem;border-radius:15px;box-shadow:0 4px 6px rgba(0,0,0,.1)}
        .h h1{color:var(--p);margin-bottom:10px;font-size:2rem}
        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;margin-bottom:2rem}
        .stat{background:var(--card);padding:1rem;border-radius:10px;text-align:center;box-shadow:0 2px 4px rgba(0,0,0,.1)}
        .stat-n{font-size:1.8rem;font-weight:bold;color:var(--p)}
        .stat-l{color:#aaa;margin-top:5px;font-size:0.8rem;}
        .cats{display:grid;gap:2rem}
        .cat{background:var(--card);border-radius:15px;padding:1.5rem;box-shadow:0 4px 6px rgba(0,0,0,.1)}
        .cat-t{font-size:1.3rem;margin-bottom:1.5rem;color:var(--p);display:flex;align-items:center;gap:10px}
        .achs{display:grid;grid-template-columns:1fr;gap:1rem}
        .ach{display:flex;align-items:center;gap:1rem;padding:1rem;border:2px solid var(--border);border-radius:10px;transition:all .3s;position:relative}
        .ach.u{border-color:var(--s);background:linear-gradient(135deg,#2a2a00,#1a1a00);transform:scale(1.02)}
        .ach.l{opacity:.6}
        .ach-i{font-size:2rem;width:50px;height:50px;display:flex;align-items:center;justify-content:center;border-radius:50%;background:var(--border);transition:all .3s;flex-shrink:0;}
        .ach.u .ach-i{background:var(--s);animation:glow 2s ease-in-out infinite alternate}
        .ach-c{flex:1}
        .ach-n{font-weight:bold;font-size:1rem;margin-bottom:5px}
        .ach-d{color:#aaa;font-size:.8rem;margin-bottom:5px}
        .ach-p{font-size:.8rem;color:var(--p);font-weight:bold}
        .ach-r{position:absolute;top:10px;right:10px;background:var(--s);color:#000;padding:4px 8px;border-radius:12px;font-size:.7rem;font-weight:bold}
        .pb{width:100%;height:6px;background:#333;border-radius:3px;margin-top:8px;overflow:hidden}
        .pf{height:100%;background:var(--p);border-radius:3px;transition:width .3s}
        @keyframes glow{from{box-shadow:0 0 5px var(--s)}to{box-shadow:0 0 20px var(--s),0 0 30px var(--s)}}
        @keyframes unlock{0%{transform:scale(1)}50%{transform:scale(1.1)}100%{transform:scale(1)}}
        .ach.ju{animation:unlock .6s ease-in-out}
    </style>
</head>
<body>
    <nav class="n">
        <a href="daily-quests.html">Quests</a>
        <a href="calendar.html">Kalender</a>
        <a href="analytics.html">Statistiken</a>
        <a href="quest-shop.html">Shop</a>
        <a href="settings.html">Einstellungen</a>
    </nav>

    <div class="h">
        <h1>Erfolge</h1>
        <p>Deine Meilensteine und Auszeichnungen</p>
    </div>
    <div class="stats">
        <div class="stat"><div class="stat-n" id="total">0</div><div class="stat-l">Freigeschaltet</div></div>
        <div class="stat"><div class="stat-n" id="points">0</div><div class="stat-l">Punkte</div></div>
        <div class="stat"><div class="stat-n" id="rate">0%</div><div class="stat-l">Fortschritt</div></div>
        <div class="stat"><div class="stat-n" id="rare">0</div><div class="stat-l">Seltene</div></div>
    </div>
    <div class="cats" id="cats"></div>
    <script>
        const defs={
            basic:{title:'🌟 Grundlagen',achs:[
                {id:'first_steps',name:'Erste Schritte',desc:'Schließe deine erste Quest ab',icon:'🎯',req:{type:'quests_completed',value:1},reward:50},
                {id:'getting_started',name:'Aller Anfang ist leicht',desc:'Schließe 5 Quests ab',icon:'🚀',req:{type:'quests_completed',value:5},reward:100},
                {id:'level_up',name:'Level Aufstieg',desc:'Erreiche Level 5',icon:'⬆️',req:{type:'level',value:5},reward:150},
                {id:'consistent',name:'Am Ball geblieben',desc:'Erreiche eine 7-Tage-Serie',icon:'🔥',req:{type:'streak',value:7},reward:200}
            ]},
            dedication:{title:'💪 Dranbleiber',achs:[
                {id:'dedicated',name:'Ehrgeizig',desc:'Erreiche eine 30-Tage-Serie',icon:'🏃',req:{type:'streak',value:30},reward:500},
                {id:'legend',name:'Legende',desc:'Erreiche eine 100-Tage-Serie',icon:'👑',req:{type:'streak',value:100},reward:1000},
                {id:'level_master',name:'Level-Meister',desc:'Erreiche Level 25',icon:'🎖️',req:{type:'level',value:25},reward:750},
                {id:'century_club',name:'Club der 100',desc:'Schließe 100 Quests ab',icon:'💯',req:{type:'quests_completed',value:100},reward:800}
            ]},
            special:{title:'✨ Besondere Leistungen',achs:[
                {id:'perfectionist',name:'Perfektionist',desc:'Schließe alle Quests an einem Tag ab',icon:'⭐',req:{type:'perfect_day',value:1},reward:300},
                {id:'early_bird',name:'Früher Vogel',desc:'Schließe eine Quest vor 8:00 Uhr ab',icon:'🌅',req:{type:'early_completion',value:1},reward:150},
                {id:'night_owl',name:'Nachteule',desc:'Schließe eine Quest nach 22:00 Uhr ab',icon:'🦉',req:{type:'late_completion',value:1},reward:150},
                {id:'weekend_warrior',name:'Wochenend-Krieger',desc:'Schließe 10 Quests am Wochenende ab',icon:'🎮',req:{type:'weekend_quests',value:10},reward:250}
            ]},
            rare:{title:'💎 Seltene Erfolge',achs:[
                {id:'xp_millionaire',name:'XP-Millionär',desc:'Sammle 10.000 XP',icon:'💰',req:{type:'total_xp',value:10000},reward:1500},
                {id:'quest_master',name:'Quest-Meister',desc:'Erstelle 20 eigene Quests',icon:'🎨',req:{type:'custom_quests',value:20},reward:1000},
                {id:'comeback_kid',name:'Comeback-Kid',desc:'Starte nach einer Pause von 7+ Tagen neu',icon:'🔄',req:{type:'comeback',value:1},reward:400}
            ]}
        };

        class AS{
            constructor(){this.achs=this.load();this.init();}
            load(){const s=localStorage.getItem('achievements');return s?JSON.parse(s):{};}
            save(){localStorage.setItem('achievements',JSON.stringify(this.achs));}
            getStats(){
                const u=JSON.parse(localStorage.getItem('userData')||'{}');
                const c=JSON.parse(localStorage.getItem('customQuests')||'[]');
                const h=JSON.parse(localStorage.getItem('completionHistory')||'[]');
                return{
                    level:u.level||1,totalXP:u.totalXP||0,currentStreak:u.streak||0,questsCompleted:h.length,customQuests:c.length,
                    perfectDays:this.countPerfect(),earlyCompletions:this.countEarly(),lateCompletions:this.countLate(),
                    weekendQuests:this.countWeekend(),comebacks:parseInt(localStorage.getItem('comebacks')||'0')
                };
            }
            countPerfect(){const h=JSON.parse(localStorage.getItem('dailyProgress')||'{}');let p=0;for(const d in h){const day=h[d];if(day.questsCompleted>=day.totalQuests&&day.totalQuests>0)p++;}return p;}
            countEarly(){return JSON.parse(localStorage.getItem('completionHistory')||'[]').filter(c=>new Date(c.timestamp).getHours()<8).length;}
            countLate(){return JSON.parse(localStorage.getItem('completionHistory')||'[]').filter(c=>new Date(c.timestamp).getHours()>=22).length;}
            countWeekend(){return JSON.parse(localStorage.getItem('completionHistory')||'[]').filter(c=>{const d=new Date(c.timestamp).getDay();return d===0||d===6;}).length;}
            checkAll(){
                const stats=this.getStats();
                console.log('Achievement Stats:', stats); // Debug
                let news=[];
                for(const cat in defs){for(const ach of defs[cat].achs){if(!this.achs[ach.id]){if(this.checkReq(ach,stats)){this.unlock(ach);news.push(ach);}}}}
                if(news.length>0)this.showUnlocks(news);
            }
            checkReq(ach,stats){
                const r=ach.req;
                switch(r.type){
                    case'level':return stats.level>=r.value;case'total_xp':return stats.totalXP>=r.value;case'streak':return stats.currentStreak>=r.value;
                    case'quests_completed':return stats.questsCompleted>=r.value;case'custom_quests':return stats.customQuests>=r.value;
                    case'perfect_day':return stats.perfectDays>=r.value;case'early_completion':return stats.earlyCompletions>=r.value;
                    case'late_completion':return stats.lateCompletions>=r.value;case'weekend_quests':return stats.weekendQuests>=r.value;
                    case'comeback':return stats.comebacks>=r.value;default:return false;
                }
            }
            unlock(ach){this.achs[ach.id]={unlockedAt:Date.now(),rewarded:false};this.save();this.awardXP(ach.reward);}
            awardXP(amt){const u=JSON.parse(localStorage.getItem('userData')||'{}');u.totalXP=(u.totalXP||0)+amt;u.level=Math.floor(u.totalXP/1000)+1;localStorage.setItem('userData',JSON.stringify(u));}
            showUnlocks(achs){
                if('Notification'in window&&Notification.permission==='granted'){new Notification('🏆 Erfolg freigeschaltet!',{body:`Du hast ${achs.length} neue Erfolge freigeschaltet!`,icon:'/favicon.ico'});}
                setTimeout(()=>{achs.forEach(ach=>{const el=document.getElementById(`ach-${ach.id}`);if(el)el.classList.add('ju');});},100);
            }
            getProgress(ach){
                const stats=this.getStats();const r=ach.req;let cur=0;
                switch(r.type){
                    case'level':cur=stats.level;break;case'total_xp':cur=stats.totalXP;break;case'streak':cur=stats.currentStreak;break;
                    case'quests_completed':cur=stats.questsCompleted;break;case'custom_quests':cur=stats.customQuests;break;
                    case'perfect_day':cur=stats.perfectDays;break;case'early_completion':cur=stats.earlyCompletions;break;
                    case'late_completion':cur=stats.lateCompletions;break;case'weekend_quests':cur=stats.weekendQuests;break;
                    case'comeback':cur=stats.comebacks;break;
                }
                return Math.min(cur,r.value);
            }
            render(){
                const cont=document.getElementById('cats');cont.innerHTML='';
                for(const[catKey,cat]of Object.entries(defs)){
                    const catEl=document.createElement('div');catEl.className='cat';
                    catEl.innerHTML=`<h2 class="cat-t">${cat.title}</h2><div class="achs">${cat.achs.map(ach=>this.renderAch(ach)).join('')}</div>`;
                    cont.appendChild(catEl);
                }
            }
            renderAch(ach){
                const isU=this.achs[ach.id];const prog=this.getProgress(ach);const perc=Math.round((prog/ach.req.value)*100);
                return`<div class="ach ${isU?'u':'l'}" id="ach-${ach.id}"><div class="ach-i">${ach.icon}</div><div class="ach-c"><div class="ach-n">${ach.name}</div><div class="ach-d">${ach.desc}</div><div class="ach-p">${isU?'Freigeschaltet!':`${prog}/${ach.req.value} (${perc}%)`}</div>${!isU?`<div class="pb"><div class="pf" style="width:${perc}%"></div></div>`:''}</div><div class="ach-r">+${ach.reward} XP</div></div>`;
            }
            updateStats(){
                const un=Object.keys(this.achs).length;
                const tot=Object.values(defs).reduce((s,cat)=>s+cat.achs.length,0);
                const pts=Object.values(defs).reduce((s,cat)=>s+cat.achs.filter(ach=>this.achs[ach.id]).reduce((s2,ach)=>s2+ach.reward,0),0);
                const rareCount=Object.keys(this.achs).filter(id=>['xp_millionaire','quest_master','comeback_kid'].includes(id)).length;
                document.getElementById('total').textContent=un;
                document.getElementById('points').textContent=pts;
                document.getElementById('rate').textContent=`${Math.round((un/tot)*100)}%`;
                document.getElementById('rare').textContent=rareCount;
            }
            init(){this.checkAll();this.render();this.updateStats();}
        }

        document.addEventListener('DOMContentLoaded',()=>{window.achievementSystem=new AS();});
        window.checkAchievements=function(){if(window.achievementSystem){window.achievementSystem.checkAll();}};
    </script>
</body>
</html>