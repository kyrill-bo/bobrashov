<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T√§gliche Quests - Dynamische Edition</title>
    <style>
        :root{--p:#666;--s:#999;--bg:#000;--card:#111;--txt:#fff;--border:#333}
        [data-theme="light"]{--p:#4CAF50;--s:#FFC107;--bg:#f5f5f5;--card:#fff;--txt:#333;--border:#ddd}
        [data-theme="dark"]{--p:#66BB6A;--s:#FFD54F;--bg:#121212;--card:#1e1e1e;--txt:#fff;--border:#333}
        [data-theme="minimal"]{--p:#000;--s:#666;--bg:#fff;--card:#fafafa;--txt:#000;--border:#eee}
        [data-theme="ocean"]{--p:#2196F3;--s:#00BCD4;--bg:#E3F2FD;--card:#fff;--txt:#0D47A1;--border:#BBDEFB}
        [data-theme="forest"]{--p:#388E3C;--s:#8BC34A;--bg:#E8F5E8;--card:#fff;--txt:#1B5E20;--border:#C8E6C9}
        *{margin:0;padding:0;box-sizing:border-box}
        body{background:var(--bg);color:var(--txt);font-family:Georgia,serif;padding:2rem;max-width:700px;margin:0 auto;line-height:1.6;transition:all .3s}
        .h{text-align:center;margin-bottom:3rem}.t{font-size:2.5rem;margin-bottom:.5rem;color:var(--p)}.st{opacity:.8;font-style:italic}
        .stats{display:flex;justify-content:space-between;margin-bottom:3rem}.stat{text-align:center}.sv{font-size:2rem;margin-bottom:.3rem;color:var(--p)}.sl{opacity:.8;font-size:.9rem}
        .prog{margin-bottom:3rem}.pi{display:flex;justify-content:space-between;margin-bottom:.5rem}
        .pb{width:100%;height:15px;background:var(--card);border:1px solid var(--border);border-radius:8px;overflow:hidden}
        .pf{height:100%;background:var(--p);width:0%;transition:width .3s}
        .q{background:var(--card);border:1px solid var(--border);padding:1.5rem;margin-bottom:1rem;border-radius:10px;transition:all .3s}
        .q.done{opacity:.6}.qh{display:flex;justify-content:space-between;margin-bottom:1rem}.qt{font-size:1.2rem}
        .qx{background:var(--s);color:var(--card);padding:.2rem .6rem;font-size:.8rem;border-radius:12px;font-weight:bold}
        .qg{text-align:center;font-size:1.5rem;margin:1rem 0}
        .btn{background:transparent;border:1px solid var(--border);color:var(--txt);padding:.6rem 1rem;cursor:pointer;font-family:inherit;border-radius:6px;transition:all .3s}
        .btn:hover{background:var(--p);color:var(--card)}.btn:disabled{opacity:.5;cursor:not-allowed}
        .r{text-align:center;margin-top:2rem;padding-top:2rem;border-top:1px solid var(--border)}
        .rb{background:transparent;border:1px solid var(--border);color:var(--txt);padding:.4rem .8rem;cursor:pointer;font-family:inherit;font-size:.8rem;border-radius:6px;opacity:.7;transition:all .3s}
        .rb:hover{opacity:1;background:var(--border)}
        .c{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--card);border:2px solid var(--p);padding:2rem;text-align:center;opacity:0;transition:opacity .3s;border-radius:15px;box-shadow:0 8px 32px rgba(0,0,0,.3)}
        .c.show{opacity:1}
        .n{text-align:center;margin-bottom:2rem;padding-bottom:1rem;border-bottom:1px solid var(--border)}
        .n a{color:var(--txt);text-decoration:none;margin:0 1rem;font-size:.9rem;opacity:.8;transition:all .3s}
        .n a:hover{color:var(--p);opacity:1}
        .event-banner{border-radius:10px;animation:pulse 2s infinite;text-align:center;margin-bottom:2rem;padding:1rem;background:var(--card);border:1px solid var(--border);display:none}
        @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,193,7,.4)}70%{box-shadow:0 0 0 10px rgba(255,193,7,0)}100%{box-shadow:0 0 0 0 rgba(255,193,7,0)}}
        @media(max-width:600px){body{padding:1rem}.stats{flex-wrap:wrap;gap:1rem}.t{font-size:2rem}}
    </style>
</head>
<body>
    <nav class="n">
        <a href="achievements.html">üèÜ Erfolge</a>
        <a href="calendar.html">üìÖ Kalender</a>
        <a href="quest-shop.html">üõí Shop</a>
        <a href="quest-editor.html">‚úèÔ∏è Quest-Editor</a>
        <a href="settings.html">‚öôÔ∏è Einstellungen</a>
        <a href="../../index.html">üè† Startseite</a>
    </nav>
    <header class="h">
        <h1 class="t">T√§gliche Quests</h1>
        <p class="st">Wo Disziplin auf dynamische Herausforderungen trifft</p>
    </header>
    <section class="stats">
        <div class="stat"><div class="sv" id="lv">1</div><div class="sl">Level</div></div>
        <div class="stat"><div class="sv" id="xp">0</div><div class="sl">Gesamt-XP</div></div>
        <div class="stat"><div class="sv" id="st">0</div><div class="sl">Serie</div></div>
        <div class="stat"><div class="sv" id="m">1.0x</div><div class="sl">XP-Multiplikator</div></div>
    </section>
    <div class="event-banner" id="event-banner">
        <div class="event-title"></div>
        <div class="event-desc"></div>
    </div>
    <section class="prog">
        <div class="pi">
            <span>Level <span id="clv">1</span></span>
            <span><span id="cur">0</span>/<span id="need">100</span> XP</span>
        </div>
        <div class="pb"><div class="pf" id="bar"></div></div>
    </section>
    <section id="q"></section>
    <div class="r"><button class="rb" onclick="reset()">Fortschritt zur√ºcksetzen</button></div>
    <div class="c" id="cel">
        <h2>Level Aufstieg!</h2>
        <p>Level <span id="nlv"></span> erreicht</p>
        <button class="btn" onclick="hide()">Weiter</button>
    </div>
    <script>
        let state = { lv: 1, xp: 0, cur: 0, need: 100, streak: 0, done: [], last: null, pf: 0, tx: 0 };
        let quests = [];
        let activeEvent = null;

        const eventSystem = {
            events: [
                { name: "Doppel-XP Montag", day: 1, multiplier: 2, description: "Alle Quests geben heute doppelte XP!" },
                { name: "Herausforderungs-Mittwoch", day: 3, challenge: true, description: "Eine besondere, schwierigere Quest erscheint heute." },
                { name: "Sommer-Challenge", month: 5, bonus: 50, description: "Erhalte 50 Bonus-XP f√ºr jede abgeschlossene Quest im Juni!" },
                { name: "Gl√ºckstag", chance: 0.1, multiplier: 1.5, description: "Heute ist dein Gl√ºckstag! Genie√üe 50% Bonus-XP auf alle Quests." }
            ],
            getActiveEvent() {
                const today = new Date();
                const dayOfWeek = today.getDay();
                const month = today.getMonth();

                const dayEvent = this.events.find(e => e.day === dayOfWeek);
                if (dayEvent) return dayEvent;

                const monthEvent = this.events.find(e => e.month === month);
                if (monthEvent) return monthEvent;

                const randomEvent = this.events.find(e => e.chance && Math.random() < e.chance);
                if (randomEvent) return randomEvent;

                return null;
            },
            applyEvent(quest, xp) {
                if (!activeEvent) return xp;
                let finalXP = xp;
                if (activeEvent.multiplier) finalXP *= activeEvent.multiplier;
                if (activeEvent.bonus) finalXP += activeEvent.bonus;
                return Math.round(finalXP);
            }
        };

        function getStreakMultiplier(streak) { return streak >= 30 ? 2 : streak >= 14 ? 1.5 : streak >= 7 ? 1.25 : 1; }

        function loadQuests() {
            let customQuests = localStorage.getItem('bq-custom');
            if (!customQuests) {
                let defaultQuests = [
                    { name: 'K√∂rperliches Training', target: 'Liegest√ºtze', xp: 50, scaling: true, baseAmount: 15, increment: 3, chain: 'Fitness' },
                    { name: 'Geistiger Fokus', target: 'Minuten Lesen', xp: 30, scaling: false, chain: 'Achtsamkeit' },
                    { name: 'Innere Ruhe', target: 'Minuten Meditation', xp: 25, scaling: false, chain: 'Achtsamkeit' }
                ];
                localStorage.setItem('bq-custom', JSON.stringify(defaultQuests));
                customQuests = JSON.stringify(defaultQuests);
            }
            quests = JSON.parse(customQuests).map(q => ({ ...q, baseTarget: q.scaling ? q.baseAmount || 15 : (q.name === 'Geistiger Fokus' ? 20 : 10) }));
            state.done = new Array(quests.length).fill(0);
        }

        function loadState() {
            let savedState = localStorage.getItem('bq');
            if (savedState) {
                state = { ...state, ...JSON.parse(savedState) };
                let today = new Date().toDateString();
                if (state.last !== today) {
                    state.done = new Array(quests.length).fill(0);
                    if (state.last && (new Date(today) - new Date(state.last)) / 86400000 > 1) {
                        state.streak = 0; state.pf = 0;
                    }
                }
            }
        }

        function saveState() {
            localStorage.setItem('bq', JSON.stringify(state));
            let userData = JSON.parse(localStorage.getItem('userData') || '{}');
            userData.level = state.lv; userData.totalXP = state.xp; userData.streak = state.streak;
            localStorage.setItem('userData', JSON.stringify(userData));
        }

        function renderQuests() {
            let html = '';
            const streakMultiplier = getStreakMultiplier(state.streak);
            quests.forEach((quest, i) => {
                if (quest.unlockLevel && state.lv < quest.unlockLevel) return;

                let target, baseXP;
                if (quest.scaling) {
                    let amount = quest.baseTarget + Math.floor((state.lv - 1) * quest.increment);
                    target = `${amount} ${quest.target}`;
                    baseXP = quest.xp + (state.lv - 1) * 5;
                } else {
                    target = `${quest.baseTarget} ${quest.target}`;
                    baseXP = quest.xp;
                }
                
                const finalXP = eventSystem.applyEvent(quest, baseXP * streakMultiplier);
                const bonusXP = finalXP - baseXP;
                const isDone = state.done[i];

                html += `<div class="q ${isDone ? 'done' : ''}" id="q${i + 1}">
                    <div class="qh">
                        <h3 class="qt">${quest.name} ${quest.chain ? `(${quest.chain})` : ''}</h3>
                        <span class="qx">+${finalXP} XP${bonusXP > 0 ? ` <small style="color:#ffc107;">(+${Math.round(bonusXP)} bonus)</small>` : ''}</span>
                    </div>
                    <div class="qg">${target}</div>
                    <button class="btn" onclick="completeQuest(${i})" ${isDone ? 'disabled' : ''}>${isDone ? 'Erledigt ‚úì' : 'Abschlie√üen'}</button>
                </div>`;
            });
            document.getElementById('q').innerHTML = html;
        }

        function updateUI() {
            document.getElementById('lv').textContent = state.lv;
            document.getElementById('xp').textContent = state.xp;
            document.getElementById('st').textContent = state.streak;
            document.getElementById('m').textContent = `${getStreakMultiplier(state.streak).toFixed(1)}x`;
            document.getElementById('clv').textContent = state.lv;
            document.getElementById('cur').textContent = state.cur;
            document.getElementById('need').textContent = state.need;
            document.getElementById('bar').style.width = `${(state.cur / state.need * 100)}%`;
            
            activeEvent = eventSystem.getActiveEvent();
            const banner = document.getElementById('event-banner');
            if (activeEvent) {
                banner.style.display = 'block';
                banner.querySelector('.event-title').textContent = `üéâ ${activeEvent.name} üéâ`;
                banner.querySelector('.event-desc').textContent = activeEvent.description;
            } else {
                banner.style.display = 'none';
            }
            renderQuests();
        }

        function completeQuest(i) {
            if (state.done[i]) return;

            let baseXP;
            if (quests[i].scaling) baseXP = quests[i].xp + (state.lv - 1) * 5; else baseXP = quests[i].xp;
            const finalXP = eventSystem.applyEvent(quests[i], baseXP * getStreakMultiplier(state.streak));

            state.done[i] = 1;
            state.xp += finalXP;
            state.cur += finalXP;
            state.last = new Date().toDateString();

            const chain = quests[i].chain;
            if (chain) {
                const chainQuests = quests.filter(q => q.chain === chain);
                const chainIndices = chainQuests.map(q => quests.indexOf(q));
                if (chainIndices.every(idx => state.done[idx])) {
                    const bonus = Math.round(chainQuests.reduce((sum, q) => sum + q.xp, 0) * 0.25);
                    state.xp += bonus;
                    state.cur += bonus;
                    showNotification(`üîó Gewohnheitsketten-Bonus!`, `Die Kette '${chain}' wurde f√ºr +${bonus} XP abgeschlossen!`);
                }
            }

            if (state.cur >= state.need) {
                state.cur -= state.need;
                state.lv++;
                state.need = Math.floor(100 * Math.pow(1.2, state.lv - 1));
                document.getElementById('nlv').textContent = state.lv;
                document.getElementById('cel').classList.add('show');
                showNotification(`üéâ Level Aufstieg!`, `Herzlichen Gl√ºckwunsch! Du hast Level ${state.lv} erreicht!`);
            }

            if (state.done.every(d => d)) {
                state.streak++;
                showNotification(`‚≠ê Perfekter Tag!`, `Alle Quests abgeschlossen! Serie: ${state.streak} Tage`);
            }

            saveState();
            updateUI();
            if (typeof window.checkAchievements === 'function') window.checkAchievements();
        }

        function hide() { document.getElementById('cel').classList.remove('show'); }
        function reset() { if (confirm('Den gesamten Fortschritt zur√ºcksetzen?')) { localStorage.removeItem('bq'); state = { lv: 1, xp: 0, cur: 0, need: 100, streak: 0, done: new Array(quests.length).fill(0), last: null, pf: 0, tx: 0 }; updateUI(); } }
        function showNotification(title, body) { /* ... implementation from before ... */ }
        function applyTheme() { const s = JSON.parse(localStorage.getItem('questSettings') || '{}'); if (s.theme) document.documentElement.setAttribute('data-theme', s.theme); }

        applyTheme();
        loadQuests();
        loadState();
        updateUI();
    </script>
</body>
</html>