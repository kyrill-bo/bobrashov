<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest Shop</title>
    <style>
        :root {
            --p: #4CAF50; --s: #FFC107; --bg: #f5f5f5; --card: #fff; --txt: #333; --border: #ddd;
            --red: #f44336; --green: #4CAF50;
        }
        [data-theme="dark"] { --p: #66BB6A; --s: #FFD54F; --bg: #121212; --card: #1e1e1e; --txt: #fff; --border: #333; }
        [data-theme="minimal"] { --p: #000; --s: #666; --bg: #fff; --card: #fafafa; --txt: #000; --border: #eee; }
        [data-theme="ocean"] { --p: #2196F3; --s: #00BCD4; --bg: #E3F2FD; --card: #fff; --txt: #0D47A1; --border: #BBDEFB; }
        [data-theme="forest"] { --p: #388E3C; --s: #8BC34A; --bg: #E8F5E8; --card: #fff; --txt: #1B5E20; --border: #C8E6C9; }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: var(--bg); color: var(--txt); font-family: Georgia, serif;
            padding: 2rem; max-width: 1200px; margin: 0 auto; line-height: 1.6; transition: all .3s;
        }
        .nav { text-align: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
        .nav a { color: var(--txt); text-decoration: none; margin: 0 1rem; font-size: .9rem; opacity: .8; transition: all .3s; }
        .nav a:hover { color: var(--p); opacity: 1; }

        .header { text-align: center; margin-bottom: 2rem; }
        .title { font-size: 2.5rem; margin-bottom: .5rem; color: var(--p); }
        .subtitle { opacity: .8; font-style: italic; }

        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat { background: var(--card); border: 1px solid var(--border); padding: 1rem; text-align: center; border-radius: 8px; }
        .stat-value { font-size: 1.5rem; color: var(--p); margin-bottom: .3rem; font-weight: bold; }
        .stat-label { font-size: .8rem; opacity: .8; }

        .category-tabs { display: flex; justify-content: center; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
        .tab { padding: .8rem 1.5rem; cursor: pointer; border: none; background: var(--card); color: var(--txt); transition: all .3s; border-radius: 8px; border: 1px solid var(--border); }
        .tab:hover { background: var(--bg); }
        .tab.active { background: var(--p); color: var(--card); border-color: var(--p); }

        .category-info { text-align: center; margin-bottom: 2rem; padding: 1rem; background: var(--card); border-radius: 8px; border: 1px solid var(--border); }
        .category-title { font-size: 1.5rem; color: var(--p); }
        .category-desc { opacity: 0.8; }

        .shop-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .shop-item { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 1.5rem; transition: all .3s; position: relative; display: flex; flex-direction: column; }
        .shop-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,.1); }
        .shop-item.locked, .shop-item.on-cooldown { opacity: .7; background: var(--bg); }
        
        .shop-item-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
        .shop-item-name { font-size: 1.2rem; font-weight: bold; color: var(--p); }
        .shop-item-price { font-size: 1.1rem; color: var(--s); font-weight: bold; }
        .shop-item-category { font-size: 0.8rem; opacity: 0.7; margin-bottom: 1rem; }
        .shop-item-desc { font-size: 0.9rem; opacity: .8; margin-bottom: 1rem; flex-grow: 1; }
        .shop-item-meta { font-size: 0.8rem; opacity: 0.7; margin-bottom: 1rem; }
        .cooldown-info, .unlock-req { display: block; margin-top: 0.5rem; }

        .btn { padding: .6rem 1.2rem; background: var(--p); color: var(--card); border: none; border-radius: 6px; cursor: pointer; font-size: .9rem; transition: all .3s; }
        .btn:hover:not(:disabled) { background: var(--s); }
        .btn:disabled { background: var(--border); color: var(--txt); opacity: .6; cursor: not-allowed; }

        .locked-badge, .cooldown-badge { font-size: .8rem; margin-left: .5rem; padding: .2rem .5rem; border-radius: 10px; }
        .locked-badge { background: var(--red); color: var(--card); }
        .cooldown-badge { background: var(--s); color: var(--txt); }

        .empty { text-align: center; opacity: .6; padding: 2rem; }

        @media(max-width:768px) {
            body { padding: 1rem; }
            .shop-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <nav class="nav">
        <a href="daily-quests.html">üéØ Daily Quests</a>
        <a href="achievements.html">üèÜ Achievements</a>
        <a href="calendar.html">üìÖ Calendar</a>
        <a href="reward-editor.html">üèÖ Manage Rewards</a>
    </nav>

    <nav class="nav">
        <a href="settings.html">‚öôÔ∏è Settings</a>
        <a href="../../index.html">üè† Home</a>
    </nav>

    <header class="header">
        <h1 class="title">üõí Quest Shop</h1>
        <p class="subtitle">Spend your hard-earned XP on cool rewards!</p>
    </header>

    <div class="stats">
        <div class="stat">
            <div class="stat-value" id="totalXP">0</div>
            <div class="stat-label">Available XP</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="totalSpent">0</div>
            <div class="stat-label">XP Spent</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="rewardsAvailable">0</div>
            <div class="stat-label">Available Rewards</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="rewardsPurchased">0</div>
            <div class="stat-label">Rewards Purchased</div>
        </div>
    </div>

    <div class="category-tabs">
        <button class="tab active" data-category="all">üåü All</button>
        <button class="tab" data-category="instant">‚ö° Instant</button>
        <button class="tab" data-category="daily">üìÖ Daily</button>
        <button class="tab" data-category="weekly">üìç Weekly</button>
        <button class="tab" data-category="monthly">üéØ Monthly</button>
        <button class="tab" data-category="subscription">üîÑ Subscriptions</button>
        <button class="tab" data-category="vip">üëë VIP</button>
    </div>

    <div class="category-info" id="categoryInfo"></div>

    <section class="shop-grid" id="shopItems"></section>

    <script>
        let shopItems = [];
        let playerXP = 0;
        let playerLevel = 1;
        let playerStreak = 0;
        let currentCategory = 'all';
        let playerStats = { totalSpent: 0, rewardsPurchased: 0 };

        const categoryInfo = {
            all: { title: "üåü All Rewards", desc: "Browse all available rewards across categories" },
            instant: { title: "‚ö° Instant Rewards", desc: "Quick treats for immediate satisfaction" },
            daily: { title: "üìÖ Daily Rewards", desc: "End-of-day celebrations and personal treats" },
            weekly: { title: "üìç Weekly Rewards", desc: "Bigger rewards for consistent weekly progress" },
            monthly: { title: "üéØ Monthly Rewards", desc: "Major purchases for long-term dedication" },
            subscription: { title: "üîÑ Subscription Rewards", desc: "Recurring services with ongoing cooldowns" },
            vip: { title: "üëë VIP Rewards", desc: "Exclusive rewards unlocked through achievements" }
        };

        document.addEventListener('DOMContentLoaded', () => {
            applyTheme();
            load();
            updateCategoryInfo();
            renderShop();
            setupEventListeners();
        });

        function applyTheme() {
            const settings = JSON.parse(localStorage.getItem('questSettings') || '{}');
            if (settings.theme) document.documentElement.setAttribute('data-theme', settings.theme);
        }

        function load() {
            shopItems = JSON.parse(localStorage.getItem('bq-shop') || '[]');
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            const questData = JSON.parse(localStorage.getItem('bq') || '{}');
            
            playerXP = questData.xp || 0;
            playerLevel = userData.level || questData.lv || 1;
            playerStreak = userData.streak || 0;

            const savedStats = JSON.parse(localStorage.getItem('shopStats') || '{}');
            playerStats = {
                totalSpent: savedStats.totalSpent || 0,
                rewardsPurchased: savedStats.rewardsPurchased || 0
            };
            updateStats();
        }

        function save() {
            localStorage.setItem('shopStats', JSON.stringify(playerStats));
            const questData = JSON.parse(localStorage.getItem('bq') || '{}');
            questData.xp = playerXP;
            localStorage.setItem('bq', JSON.stringify(questData));
        }

        function updateStats() {
            document.getElementById('totalXP').textContent = playerXP;
            document.getElementById('totalSpent').textContent = playerStats.totalSpent;
            document.getElementById('rewardsAvailable').textContent = shopItems.length;
            document.getElementById('rewardsPurchased').textContent = playerStats.rewardsPurchased;
        }

        function checkUnlockRequirement(requirement) {
            if (!requirement) return true;
            const reqLevel = (requirement.match(/Level (\d+)/) || [])[1];
            const reqStreak = (requirement.match(/Streak (\d+)/) || [])[1];
            // This is a simplified check. A full implementation would need to parse achievements.
            return (!reqLevel || playerLevel >= parseInt(reqLevel)) && (!reqStreak || playerStreak >= parseInt(reqStreak));
        }

        function isOnCooldown(item) {
            if (!item.cooldown || !item.lastPurchased) return false;
            const cooldownMillis = item.cooldown * 24 * 60 * 60 * 1000;
            return (Date.now() - new Date(item.lastPurchased).getTime()) < cooldownMillis;
        }

        function getCooldownDays(item) {
            if (!isOnCooldown(item)) return 0;
            const cooldownMillis = item.cooldown * 24 * 60 * 60 * 1000;
            const elapsed = Date.now() - new Date(item.lastPurchased).getTime();
            return Math.ceil((cooldownMillis - elapsed) / (1000 * 60 * 60 * 24));
        }

        function renderShop() {
            const container = document.getElementById('shopItems');
            const filtered = currentCategory === 'all' ? shopItems : shopItems.filter(i => i.category === currentCategory);
            
            if (filtered.length === 0) {
                container.innerHTML = `<div class="empty">No rewards in this category. <a href=\"reward-editor.html\">Add rewards</a> to see them here!</div>`;
                return;
            }

            container.innerHTML = filtered.map(item => {
                const isUnlocked = checkUnlockRequirement(item.unlock);
                const onCooldown = isOnCooldown(item);
                const canAfford = playerXP >= item.cost;
                const cooldownDays = getCooldownDays(item);

                let statusBadge = '';
                let buttonText = 'Purchase';
                let buttonDisabled = false;

                if (!isUnlocked) {
                    statusBadge = `<span class="locked-badge">üîí Locked</span>`;
                    buttonText = `Locked (${item.unlock})`;
                    buttonDisabled = true;
                } else if (onCooldown) {
                    statusBadge = `<span class="cooldown-badge">‚è∞ Cooldown</span>`;
                    buttonText = `On Cooldown (${cooldownDays}d)`;
                    buttonDisabled = true;
                } else if (!canAfford) {
                    buttonText = 'Insufficient XP';
                    buttonDisabled = true;
                }

                return `
                    <div class="shop-item ${!isUnlocked ? 'locked' : ''} ${onCooldown ? 'on-cooldown' : ''}">
                        <div class="shop-item-header">
                            <h3 class="shop-item-name">${item.name} ${statusBadge}</h3>
                            <span class="shop-item-price">${item.cost} XP</span>
                        </div>
                        <div class="shop-item-category">üìÇ ${item.category}</div>
                        <p class="shop-item-desc">${item.desc}</p>
                        <div class="shop-item-meta">
                            ${item.cooldown ? `<span class="cooldown-info">‚è∞ ${item.cooldown} day cooldown</span>` : ''}
                            ${item.unlock ? `<span class="unlock-req">üîê Requires: ${item.unlock}</span>` : ''}
                        </div>
                        <div style="margin-top: auto;">
                            <button class="btn buy" onclick="buyItem('${item.id}')" ${buttonDisabled ? 'disabled' : ''}>${buttonText}</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function buyItem(id) {
            const itemIndex = shopItems.findIndex(i => i.id == id);
            if (itemIndex === -1) return;
            
            const item = shopItems[itemIndex];
            if (playerXP < item.cost || !checkUnlockRequirement(item.unlock) || isOnCooldown(item)) {
                alert('Cannot purchase this item.');
                return;
            }

            playerXP -= item.cost;
            playerStats.totalSpent += item.cost;
            playerStats.rewardsPurchased++;
            item.lastPurchased = new Date().toISOString();

            // We need to update the original array in localStorage
            const allShopItems = JSON.parse(localStorage.getItem('bq-shop') || '[]');
            const globalItemIndex = allShopItems.findIndex(i => i.id == id);
            if (globalItemIndex !== -1) {
                allShopItems[globalItemIndex] = item;
                localStorage.setItem('bq-shop', JSON.stringify(allShopItems));
            }

            save();
            updateStats();
            renderShop();
            alert(`Purchased ${item.name}!`);
        }

        function updateCategoryInfo() {
            const info = categoryInfo[currentCategory];
            document.getElementById('categoryInfo').innerHTML = `
                <div class="category-title">${info.title}</div>
                <div class="category-desc">${info.desc}</div>`;
        }

        function setupEventListeners() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelector('.tab.active').classList.remove('active');
                    tab.classList.add('active');
                    currentCategory = tab.dataset.category;
                    updateCategoryInfo();
                    renderShop();
                });
            });
        }
    </script>
</body>
</html>