<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest-Shop</title>
    <style>
        :root {
            --p: #66BB6A; --s: #FFD54F; --bg: #121212; --card: #1e1e1e; --txt: #fff; --border: #333;
            --red: #f44336; --green: #4CAF50;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: var(--bg); color: var(--txt); font-family: Georgia, serif;
            padding: 1rem; max-width: 1200px; margin: 0 auto; line-height: 1.6;
        }
        .nav { text-align: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
        .nav a { color: var(--txt); text-decoration: none; margin: 0 .5rem; font-size: .9rem; opacity: .8; transition: all .3s; }
        .nav a:hover { color: var(--p); opacity: 1; }

        .header { text-align: center; margin-bottom: 2rem; }
        .title { font-size: 2rem; margin-bottom: .5rem; color: var(--p); }
        .subtitle { opacity: .8; font-style: italic; }

        .stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 2rem; }
        .stat { background: var(--card); border: 1px solid var(--border); padding: 1rem; text-align: center; border-radius: 8px; }
        .stat-value { font-size: 1.5rem; color: var(--p); margin-bottom: .3rem; font-weight: bold; }
        .stat-label { font-size: .8rem; opacity: .8; }

        .category-tabs { display: flex; justify-content: center; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
        .tab { padding: .6rem 1rem; cursor: pointer; border: none; background: var(--card); color: var(--txt); transition: all .3s; border-radius: 8px; border: 1px solid var(--border); font-size: 0.9rem; }
        .tab:hover { background: var(--bg); }
        .tab.active { background: var(--p); color: var(--card); border-color: var(--p); }

        .category-info { text-align: center; margin-bottom: 2rem; padding: 1rem; background: var(--card); border-radius: 8px; border: 1px solid var(--border); }
        .category-title { font-size: 1.3rem; color: var(--p); }
        .category-desc { opacity: 0.8; font-size: 0.9rem; }

        .shop-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; margin-bottom: 2rem; }
        .shop-item { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 1.5rem; transition: all .3s; position: relative; display: flex; flex-direction: column; }
        .shop-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,.1); }
        .shop-item.locked, .shop-item.on-cooldown { opacity: .7; background: var(--bg); }
        
        .shop-item-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
        .shop-item-name { font-size: 1.2rem; font-weight: bold; color: var(--p); }
        .shop-item-price { font-size: 1.1rem; color: var(--s); font-weight: bold; }
        .shop-item-category { font-size: 0.8rem; opacity: 0.7; margin-bottom: 1rem; }
        .shop-item-desc { font-size: 0.9rem; opacity: .8; margin-bottom: 1rem; flex-grow: 1; }
        .shop-item-meta { font-size: 0.8rem; opacity: 0.7; margin-bottom: 1rem; }
        .cooldown-info, .unlock-req { display: block; margin-top: 0.5rem; }

        .btn { padding: .8rem 1.2rem; background: var(--p); color: var(--card); border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; transition: all .3s; width: 100%; }
        .btn:hover:not(:disabled) { background: var(--s); color: #000; }
        .btn:disabled { background: var(--border); color: var(--txt); opacity: .6; cursor: not-allowed; }

        .locked-badge, .cooldown-badge { font-size: .8rem; margin-left: .5rem; padding: .2rem .5rem; border-radius: 10px; }
        .locked-badge { background: var(--red); color: var(--card); }
        .cooldown-badge { background: var(--s); color: var(--txt); }

        .empty { text-align: center; opacity: .6; padding: 2rem; }
    </style>
</head>
<body>
    <nav class="nav">
        <a href="daily-quests.html">Quests</a>
        <a href="achievements.html">Erfolge</a>
        <a href="calendar.html">Kalender</a>
        <a href="reward-editor.html">Editor</a>
        <a href="settings.html">Einstellungen</a>
    </nav>
    <header class="header">
        <h1 class="title">Quest-Shop</h1>
        <p class="subtitle">Gib deine hart verdienten XP f√ºr coole Belohnungen aus!</p>
    </header>

    <div class="stats">
        <div class="stat">
            <div class="stat-value" id="totalXP">0</div>
            <div class="stat-label">Verf√ºgbare XP</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="totalSpent">0</div>
            <div class="stat-label">Ausgegebene XP</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="rewardsAvailable">0</div>
            <div class="stat-label">Belohnungen</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="rewardsPurchased">0</div>
            <div class="stat-label">Gekauft</div>
        </div>
    </div>

    <div class="category-tabs">
        <button class="tab active" data-category="all">Alle</button>
        <button class="tab" data-category="instant">Sofort</button>
        <button class="tab" data-category="daily">T√§glich</button>
        <button class="tab" data-category="weekly">W√∂chentlich</button>
        <button class="tab" data-category="monthly">Monatlich</button>
        <button class="tab" data-category="subscription">Abo</button>
        <button class="tab" data-category="vip">VIP</button>
    </div>

    <div class="category-info" id="categoryInfo"></div>

    <section class="shop-grid" id="shopItems"></section>

    <script>
        let shopItems = [];
        let playerXP = 0;
        let playerLevel = 1;
        let playerStreak = 0;
        let currentCategory = 'all';
        let playerStats = { totalSpent: 0, rewardsPurchased: 0 };

        const categoryInfo = {
            all: { title: "üåü Alle Belohnungen", desc: "Durchsuche alle verf√ºgbaren Belohnungen" },
            instant: { title: "‚ö° Sofortige Belohnungen", desc: "Schnelle Belohnungen f√ºr sofortige Befriedigung" },
            daily: { title: "üìÖ T√§gliche Belohnungen", desc: "Belohnungen am Ende des Tages" },
            weekly: { title: "üìç W√∂chentliche Belohnungen", desc: "Gr√∂√üere Belohnungen f√ºr w√∂chentlichen Fortschritt" },
            monthly: { title: "üéØ Monatliche Belohnungen", desc: "Gro√üe Anschaffungen f√ºr langfristiges Engagement" },
            subscription: { title: "üîÑ Abonnement-Belohnungen", desc: "Wiederkehrende Dienste" },
            vip: { title: "üëë VIP-Belohnungen", desc: "Exklusive Belohnungen f√ºr treue Spieler" }
        };

        document.addEventListener('DOMContentLoaded', () => {
            load();
            updateCategoryInfo();
            renderShop();
            setupEventListeners();
        });

        function load() {
            shopItems = JSON.parse(localStorage.getItem('bq-shop') || '[]');
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            const questData = JSON.parse(localStorage.getItem('bq') || '{}');
            
            playerXP = questData.xp || 0;
            playerLevel = userData.level || questData.lv || 1;
            playerStreak = userData.streak || 0;

            const savedStats = JSON.parse(localStorage.getItem('shopStats') || '{}');
            playerStats = {
                totalSpent: savedStats.totalSpent || 0,
                rewardsPurchased: savedStats.rewardsPurchased || 0
            };
            updateStats();
        }

        function save() {
            localStorage.setItem('shopStats', JSON.stringify(playerStats));
            const questData = JSON.parse(localStorage.getItem('bq') || '{}');
            questData.xp = playerXP;
            localStorage.setItem('bq', JSON.stringify(questData));
        }

        function updateStats() {
            document.getElementById('totalXP').textContent = playerXP;
            document.getElementById('totalSpent').textContent = playerStats.totalSpent;
            document.getElementById('rewardsAvailable').textContent = shopItems.length;
            document.getElementById('rewardsPurchased').textContent = playerStats.rewardsPurchased;
        }

        function checkUnlockRequirement(requirement) {
            if (!requirement) return true;
            const reqLevel = (requirement.match(/Level (\d+)/) || [])[1];
            const reqStreak = (requirement.match(/Streak (\d+)/) || [])[1];
            return (!reqLevel || playerLevel >= parseInt(reqLevel)) && (!reqStreak || playerStreak >= parseInt(reqStreak));
        }

        function isOnCooldown(item) {
            if (!item.cooldown || !item.lastPurchased) return false;
            const cooldownMillis = item.cooldown * 24 * 60 * 60 * 1000;
            return (Date.now() - new Date(item.lastPurchased).getTime()) < cooldownMillis;
        }

        function getCooldownDays(item) {
            if (!isOnCooldown(item)) return 0;
            const cooldownMillis = item.cooldown * 24 * 60 * 60 * 1000;
            const elapsed = Date.now() - new Date(item.lastPurchased).getTime();
            return Math.ceil((cooldownMillis - elapsed) / (1000 * 60 * 60 * 24));
        }

        function renderShop() {
            const container = document.getElementById('shopItems');
            const filtered = currentCategory === 'all' ? shopItems : shopItems.filter(i => i.category === currentCategory);
            
            if (filtered.length === 0) {
                container.innerHTML = `<div class="empty">Keine Belohnungen in dieser Kategorie. <a href=\"reward-editor.html\">F√ºge Belohnungen hinzu</a>, um sie hier zu sehen!</div>`;
                return;
            }

            container.innerHTML = filtered.map(item => {
                const isUnlocked = checkUnlockRequirement(item.unlock);
                const onCooldown = isOnCooldown(item);
                const canAfford = playerXP >= item.cost;
                const cooldownDays = getCooldownDays(item);

                let statusBadge = '';
                let buttonText = 'Kaufen';
                let buttonDisabled = false;

                if (!isUnlocked) {
                    statusBadge = `<span class="locked-badge">üîí Gesperrt</span>`;
                    buttonText = `Gesperrt (${item.unlock})`;
                    buttonDisabled = true;
                } else if (onCooldown) {
                    statusBadge = `<span class="cooldown-badge">‚è∞ Abklingzeit</span>`;
                    buttonText = `Abklingzeit (${cooldownDays}d)`;
                    buttonDisabled = true;
                } else if (!canAfford) {
                    buttonText = 'Nicht gen√ºgend XP';
                    buttonDisabled = true;
                }

                return `
                    <div class="shop-item ${!isUnlocked ? 'locked' : ''} ${onCooldown ? 'on-cooldown' : ''}">
                        <div class="shop-item-header">
                            <h3 class="shop-item-name">${item.name} ${statusBadge}</h3>
                            <span class="shop-item-price">${item.cost} XP</span>
                        </div>
                        <div class="shop-item-category">üìÇ ${item.category}</div>
                        <p class="shop-item-desc">${item.desc}</p>
                        <div class="shop-item-meta">
                            ${item.cooldown ? `<span class="cooldown-info">‚è∞ ${item.cooldown} Tage Abklingzeit</span>` : ''}
                            ${item.unlock ? `<span class="unlock-req">üîê Ben√∂tigt: ${item.unlock}</span>` : ''}
                        </div>
                        <div style="margin-top: auto;">
                            <button class="btn buy" onclick="buyItem('${item.id}')" ${buttonDisabled ? 'disabled' : ''}>${buttonText}</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function buyItem(id) {
            const itemIndex = shopItems.findIndex(i => i.id == id);
            if (itemIndex === -1) return; 
            
            const item = shopItems[itemIndex];
            if (playerXP < item.cost || !checkUnlockRequirement(item.unlock) || isOnCooldown(item)) {
                alert('Dieser Gegenstand kann nicht gekauft werden.');
                return;
            }

            playerXP -= item.cost;
            playerStats.totalSpent += item.cost;
            playerStats.rewardsPurchased++;
            item.lastPurchased = new Date().toISOString();

            const allShopItems = JSON.parse(localStorage.getItem('bq-shop') || '[]');
            const globalItemIndex = allShopItems.findIndex(i => i.id == id);
            if (globalItemIndex !== -1) {
                allShopItems[globalItemIndex] = item;
                localStorage.setItem('bq-shop', JSON.stringify(allShopItems));
            }

            save();
            updateStats();
            renderShop();
            alert(`${item.name} gekauft!`);
        }

        function updateCategoryInfo() {
            const info = categoryInfo[currentCategory];
            document.getElementById('categoryInfo').innerHTML = `
                <div class="category-title">${info.title}</div>
                <div class="category-desc">${info.desc}</div>`;
        }

        function setupEventListeners() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelector('.tab.active').classList.remove('active');
                    tab.classList.add('active');
                    currentCategory = tab.dataset.category;
                    updateCategoryInfo();
                    renderShop();
                });
            });
        }
    </script>
</body>
</html>